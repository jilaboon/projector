generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?

  // URLs and Links
  productionUrl   String?
  stagingUrl      String?
  vercelProjectUrl String?
  githubRepoUrl   String?

  // Documentation
  readme          String?
  architecture    String?
  notes           String?

  // Tech Stack
  techStack       String?   // JSON array of technologies

  // Status
  status          String    @default("active") // active, archived, in-development

  // Credentials (encrypted)
  credentials     Credential[]

  // Environment Variables
  envVariables    EnvVariable[]

  // Tasks
  tasks           Task[]

  // Tags for organization
  tags            String?   // JSON array of tags

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Credential {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  label       String   // e.g., "Admin Login", "Database", "API Key"
  username    String?  // encrypted
  password    String?  // encrypted
  url         String?
  notes       String?  // encrypted

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model EnvVariable {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  environment String   // production, staging, development
  key         String
  value       String   // encrypted

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Task {
  id             String   @id @default(cuid())
  projectId      String
  project        Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title          String
  description    String?  // markdown
  status         String   @default("TODO")       // BACKLOG, TODO, IN_PROGRESS, BLOCKED, DONE
  priority       String   @default("MEDIUM")      // LOW, MEDIUM, HIGH, CRITICAL
  labels         String?  // JSON array of strings

  dueDate        DateTime?
  completedAt    DateTime?
  estimateHours  Int?
  blockedReason  String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  activityLog    TaskActivityLog[]

  @@index([projectId])
  @@index([status])
  @@index([priority])
}

model TaskActivityLog {
  id        String   @id @default(cuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  eventType String   // TASK_CREATED, STATUS_CHANGED, DESCRIPTION_UPDATED, COMPLETED, REOPENED
  payload   String?  // JSON - extra context (e.g., { from: "TODO", to: "IN_PROGRESS" })

  timestamp DateTime @default(now())

  @@index([taskId])
}

model AppSettings {
  id              String   @id @default("settings")
  appPasswordHash String?  // hashed password to access the app
  encryptionKey   String?  // stored encrypted, used for credentials
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Proposal {
  id              String   @id @default(cuid())

  // Customer info
  customerName    String
  customerEmail   String?
  customerPhone   String?
  customerCompany String?

  // Proposal details
  title           String
  requirements    String   // Free text - main requirements/description
  notes           String?  // Additional notes

  // Pricing (optional)
  estimatedPrice  Float?
  currency        String   @default("ILS")

  // Status
  status          String   @default("draft") // draft, sent, accepted, rejected, in-progress, completed

  // Dates
  sentAt          DateTime?
  respondedAt     DateTime?
  deadline        DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Service {
  id              String   @id @default(cuid())
  name            String   // e.g., "Vercel", "Supabase", "Claude Code"
  category        String?  // e.g., "Hosting", "Database", "AI", "Domain", "Email"

  // Pricing
  price           Float    // Amount per billing cycle
  currency        String   @default("USD") // USD, EUR, ILS, etc.
  billingCycle    String   @default("monthly") // monthly, yearly, one-time

  // Subscription details
  autoRenew         Boolean  @default(true)
  remindBeforeRenew Boolean  @default(false) // Highlight in red as reminder
  startDate         DateTime?
  nextBillingDate   DateTime?

  // Status
  status          String   @default("active") // active, cancelled, paused, trial

  // Additional info
  url             String?  // Service URL/dashboard
  accountEmail    String?  // Account used for this service
  notes           String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
